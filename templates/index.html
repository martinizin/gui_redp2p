<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Simulación de Red de Fibra Óptica</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}" />
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
    />
    <script
        type="text/javascript"
        src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"
    ></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Pila de fuentes modernas para la interfaz */
            background-color: #eef1f5; /* Gris claro ligeramente más frío */
            margin: 0;
            padding-top: 15px; 
            color: #333; /* Color de texto por defecto */
        }

        h1, h3, h5 {
            color: #343a40; /* Color de encabezado más oscuro y estándar */
        }
        h1 {
            font-weight: 600;
            text-align: center;
            margin-bottom: 25px; /* Margen ligeramente menor */
        }
        h3 {
            font-weight: 500;
            margin-top: 25px; 
            margin-bottom: 15px;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
        }
        h5 {
            font-weight: 500;
            color: #495057; 
        }

        /* Contenedor principal para resultados y gráficas */
        .container-main {
            max-width: 900px; 
            margin: 20px auto; 
            padding: 20px;
            background-color: #ffffff; 
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Sombra mejorada */
        }

        /* Contenedor de visualización de red */
        #red {
            height: 480px; /* Ligeramente más alto */
            width: 100%; 
            border: 1px solid #dee2e6; /* Color de borde consistente */
            background-color: #ffffff; 
            border-radius: 6px; /* Radio consistente */
            margin-top: 0; 
            box-sizing: border-box;
            position: relative; /* Para posicionamiento absoluto de controles internos */
        }
        
        /* Estilo de botones (general, puede ser sobrescrito) */
        .btn {
            border-radius: 5px;
            padding: 10px 20px;
            font-weight: 500;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        .btn-success:hover {
            background-color: #1e7e34;
            border-color: #1e7e34;
        }
        .calulos-button { /* Clase para el botón principal de cálculo */
            padding: 10px 24px; 
            font-size: 1.05rem;
            font-weight: 500;
        }

        /* Estilo de formularios */
        .form-label {
            font-weight: 500;
            color: #495057;
        }
        .form-control, .form-select {
            border-radius: 5px;
            border-color: #ced4da;
        }
        .form-control:focus, .form-select:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        /* Estilo de texto del contenedor de resultados */
        #resultados-container {
            width: 100%; /* Hace que el contenedor llene el ancho de su padre */
            padding-left: 15px; /* Añade relleno si se usa container-fluid */
            padding-right: 15px; /* Añade relleno si se usa container-fluid */
        }
        #resultados-container strong {
            color: #2c3e50;
        }

        /* Estilo personalizado de tooltip */
        .tooltip-custom {
            position: fixed; 
            z-index: 10000; 
            pointer-events: none;
            user-select: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            padding: 10px 15px;
            font-size: 13px;
            border-radius: 6px;
            background: #fff;
            border: 1px solid #eee;
            opacity: 0.95; 
            transition: opacity 0.2s ease-in-out;
        }
        .tooltip-custom strong {
            color: #007bff; 
        }

        /* Estilo de modal */
        .modal-content {
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,.5);
        }
        .modal-header {
            background-color: #f8f9fa; 
            border-bottom: 1px solid #dee2e6;
            color: #2c3e50;
        }
        .modal-title {
            font-weight: 500;
        }

        /* Contenedor para el canvas de Vis.js y sus controles superpuestos */
        #network-container-wrapper {
            height: 500px;
            width: 100%;
            padding: 0; /* El relleno ahora lo maneja network-column */
            background-color: transparent; /* El network-column padre proporciona el fondo */
            box-shadow: none; /* El network-column padre proporciona la sombra */
            margin-bottom: 15px; /* Espacio antes del botón "Realizar Calculos" */
            position: relative; 
        }
        
        /* Estilo para las columnas principales */
        .col-md-8, .col-md-4 {
            padding-left: 8px; /* Espaciado más estrecho */
            padding-right: 8px;
        }
        /* Estilo específico para la columna izquierda que contiene la red */
        .network-column { 
            background-color: #ffffff;
            padding: 15px; /* Relleno interno para la columna */
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px; /* Margen inferior general para esta columna */
        }

        /* Controles personalizados de red (Zoom, Ajustar) - Flechas de panorámica eliminadas */
        #custom-network-controls {
            position: absolute;
            top: 10px; 
            left: 10px;
            z-index: 100; 
            background-color: rgba(248, 249, 250, 0.92); 
            padding: 8px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            display: flex;
            /* flex-direction: column; /* No necesario si solo hay un grupo */
            gap: 4px; /* Espacio entre botones si están en una sola fila/grupo */
        }
        /* #custom-network-controls .control-group { 
            display: flex; Eliminado ya que el grupo de flechas de panorámica desapareció 
            gap: 4px;
        } */
        #custom-network-controls button {
            min-width: 36px; 
            height: 36px;
            line-height: 1; 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 8px; 
            font-size: 1rem; 
            font-weight: 500; 
            text-align: center;
            border: 1px solid #ced4da;
            background-color: #ffffff;
            color: #495057;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        #custom-network-controls button:hover {
            background-color: #f8f9fa; 
            border-color: #adb5bd;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25); 
        }
        

        /* Botón de reinicio de diseño */
        #resetLayoutButton {
            position: absolute;
            top: 10px; /* Coincide con los controles personalizados */
            right: 10px;
            z-index: 100;
        }
        #resetLayoutButton.btn-light { 
            background-color: #f8f9fa;
            border-color: #ced4da;
            color: #212529;
            height: 36px; /* Coincide con la altura de los controles personalizados */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 10px; 
        }
        #resetLayoutButton.btn-light:hover {
            background-color: #e2e6ea;
            border-color: #dae0e5;
        }
       


        /* Panel derecho: Configuración de tramos - Hecho más pequeño */
        #span-configuration-panel {
            background-color: #ffffff; 
            padding: 15px; /* Relleno reducido */
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            max-height: 548px;
         
            /* max-width: 300px; /* Opcional: descomentar si aún es muy ancho */
            /* margin-left: auto; /* Opcional: si se usa max-width y la estructura de columnas lo permite */
            /* margin-right: auto; /* Opcional: si se usa max-width y la estructura de columnas lo permite */
        }
        #span-configuration-panel h5 {
            margin-top: 0;
            font-size: 1.1rem; /* Título ligeramente más pequeño */
            color: #343a40; 
            padding-bottom: 8px; /* Relleno reducido */
            margin-bottom: 12px; /* Margen reducido */
            border-bottom: 1px solid #dee2e6;
            height: 40px;
        }
        #span-configuration-panel .form-label {
            margin-bottom: .3rem; /* Margen de etiqueta más estrecho */
            font-size: 0.9rem; /* Fuente de etiqueta más pequeña */
            font-weight: 500;
            color: #495057;
        }
        #span-configuration-panel .form-select,
        #span-configuration-panel .form-control { 
            margin-bottom: 8px; /* Margen de control más estrecho */
            font-size: 0.9rem; /* Fuente más pequeña en controles */
            height: 40px;
        }
        #span-configuration-panel #saveFiberSpans {
            font-size: 0.85rem; /* Fuente de botón más pequeña */
            padding: 0.4rem 0.8rem; /* Relleno de botón más pequeño */
        }

        /* Contenedor del botón "Realizar Calculos" */
        .realizar-calculos-container {
            text-align: center;
            padding: 10px 0 0 0; 
            /* Esta clase está ahora en un div que podría estar directamente en container-fluid */
            /* Se añade margin-bottom aquí si se mueve arriba de los resultados */
            margin-bottom: 20px; 
        }
        
        /* Estilo de gráficas Plotly */
        #plotly-graph-dbm, #plotly-graph-linear {
            min-height: 380px; 
            width: 100%;
            background-color: #fcfcfc; 
            border: 1px solid #e0e0e0; 
            border-radius: 6px;
            margin-top: 10px; 
        }
        .container-main h3 + .row { /* Espacio entre H3 y la primera fila de gráfica */
            margin-top: 5px;
        }

    </style>
</head>
<body>
    <!-- Contenedor para el título principal -->
    <div class="container-fluid">
        <h1>Simulación de Red de Fibra Óptica</h1>
        {% include 'scenario_nav.html' %}
    </div>

    <div class="container-fluid">
        <div class="row align-items-stretch">
            <!-- Columna de la Red (Izquierda) -->
            <div class="col-md-9 network-column h-125">
                <div id="network-container-wrapper">
                    <div id="custom-network-controls"> 
                        <!-- Pan arrows group removed -->
                        <!-- <div class="control-group">
                            <button id="panUpBtn" title="Pan Up">&uarr;</button>
                            <button id="panDownBtn" title="Pan Down">&darr;</button>
                            <button id="panLeftBtn" title="Pan Left">&larr;</button>
                            <button id="panRightBtn" title="Pan Right">&rarr;</button>
                        </div> -->
                    </div>
                    <div id="red"></div>
                    <button id="resetLayoutButton" class="btn btn-light btn-sm" title="Restablecer Diseño"> 
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-counterclockwise" viewBox="0 0 16 16">
                            <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2z"/>
                            <path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.19a.25.25 0 0 0 0 .384l2.36 1.848A.25.25 0 0 0 8 4.466"/>
                        </svg>
                        <span style="margin-left: 5px;">Restablecer</span>
                    </button> 
                </div>
                <!-- "Realizar Calculos" button MOVING FROM HERE -->
            </div>

            <!-- Columna de Controles y Formularios (Derecha) -->
            <div class="col-md-3">
                <div id="span-configuration-panel" class="p-10 bg-light border rounded h-100 mt-20">
                    <h5>Configuración de Tramos</h5>
                    <div class="mb-3">
                        <label for="fiberSpanSelector" class="form-label">Número de Tramos de Fibra:</label>
                        <select id="fiberSpanSelector" class="form-select">
                            <option value="1" selected>1 Tramo</option>
                            <option value="2">2 Tramos</option>
                            <option value="3">3 Tramos</option>
                            <option value="4">4 Tramos</option>
                        </select>
                    </div>
                    <button id="saveFiberSpans" class="btn btn-primary mt-2 w-100">Actualizar N° de Tramos de Fibra</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenedor principal para resultados (debajo de la red y controles) -->
    <!-- Changed to container-fluid for full width -->
    <div class="container-fluid">
        <!-- "Realizar Calculos" button MOVED TO HERE -->
        <div class="realizar-calculos-container" style="text-align: center; margin-bottom: 20px;">
            <button class="calulos-button btn btn-success btn-lg">Realizar Cálculos</button>
        </div>
        <!-- 2. RESULTADOS INICIALES -->
        <div id="resultados-container" class="mt-4"></div>

        <!-- Contenedor para gráficas Plotly, also making this container-fluid -->
        <div class="container-fluid mt-4">
            <h3>Gráficas de Potencia vs Longitud</h3>
            <div class="row">
                <div class="col-md-10 mx-auto">
                    <h5>Potencia (dBm)</h5>
                    <div id="plotly-graph-dbm"></div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-10 mx-auto">
                    <h5>Potencia (Lineal - mili Watts)</h5>
                    <div id="plotly-graph-linear"></div>
                </div>
            </div>
            
        </div>

        <!-- Modal para edición (sin cambios) -->
        <div
            class="modal fade"
            id="editNodeModal"
            tabindex="-1"
            aria-labelledby="editNodeModalLabel"
            aria-hidden="true"
        >
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editNodeModalLabel">Editar Nodo</h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                        ></button>
                    </div>
                    <div class="modal-body">
                        <form id="editNodeForm">
                            <div class="mb-3" id="modalNodeLabelContainer">
                                <label for="nodeLabel" class="form-label">Etiqueta (Label)</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    id="nodeLabel"
                                    name="label"
                                />
                            </div>
                            <div class="mb-3" id="modalNodePotenciaContainer">
                                <label for="nodePotencia" class="form-label">Potencia (Power)</label>
                                <input
                                    type="number"
                                    class="form-control"
                                    id="nodePotencia"
                                    name="potencia"
                                />
                            </div>
                            <div id="additionalParams"></div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                        >
                            Cerrar
                        </button>
                        <button type="button" class="btn btn-primary" id="saveNodeChanges">
                            Guardar Cambios
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>

function dbmToMw(dbm) {
    return Math.pow(10, parseFloat(dbm) / 10);
}

function mwToDbm(mw) {
    const mwFloat = parseFloat(mw);
    if (mwFloat <= 0) { // La potencia debe ser > 0 para el logaritmo
        // Devuelve un valor muy pequeño de dBm o lo maneja como estado de error
        // Por ejemplo, -100 dBm es 1e-10 mW, efectivamente cero para muchos propósitos prácticos
        return -100; // O manejar como error, ej., throw new Error("La potencia en mW debe ser positiva.");
    }
    return 10 * Math.log10(mwFloat);
}

// Conjuntos de datos globales de Vis.js
let nodos = new vis.DataSet([]);
let enlaces = new vis.DataSet([]);
let red = null; // instancia de red

// Parámetros globales (editables a través de la interfaz)
let globalTxPowerDbm = 30.0;
let globalDisplayTxPowerValue = 30.0; // Persiste el último valor de visualización ingresado por el usuario para Tx
let globalDisplayTxPowerUnit = 'dBm';   // Persiste la última unidad de visualización ingresada por el usuario para Tx
let globalReceiverSensitivityDbm = 14.0;
let persistentSpanParams = {}; // Añadido para parámetros de tramo duraderos


document.querySelector('.calulos-button').addEventListener('click', function () {
    // Recopila parámetros para el cálculo
    const fiber_params = [];
    enlaces.get().forEach(edge => {
        // Asegura que todos los parámetros necesarios estén presentes y correctamente tipados
        fiber_params.push({
            // id: edge.id, // útil para depuración o actualizaciones más complejas
            loss_coef: parseFloat(edge.parametros['loss_coef'] || 0.2),
            att_in: parseFloat(edge.parametros['att_in'] || 0),
            con_in: parseFloat(edge.parametros['con_in'] || 0.25),
            con_out: parseFloat(edge.parametros['con_out'] || 0.30),
            length_stretch: parseFloat(edge.parametros['length_stretch'] || 23) // Clave estandarizada
        });
    });
    
    // Obtiene la potencia Tx y sensibilidad Rx de los nodos respectivos
    // Estos se actualizan si el usuario edita directamente los nodos Transmisor/Receptor
    const transmisorNode = nodos.get(1); // Asumiendo que ID 1 es Transmisor
    const receptorNode = nodos.get(3);   // Asumiendo que ID 3 es Receptor

    if (transmisorNode && transmisorNode.potencia !== undefined) {
        globalTxPowerDbm = parseFloat(transmisorNode.potencia);
    }
    if (receptorNode && receptorNode.sensibilidad_receptor_dbm !== undefined) {
        globalReceiverSensitivityDbm = parseFloat(receptorNode.sensibilidad_receptor_dbm);
    }


    const payload = {
        tx_power_dbm: globalTxPowerDbm,
        sensitivity_receiver_dbm: globalReceiverSensitivityDbm,
        fiber_params: fiber_params
    };

    // Envía solicitud AJAX al backend de Flask
    fetch('/calcular', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(resultados => {
        // Muestra el contenedor de resultados
        document.getElementById('resultados-container').style.display = 'block';

        // Actualiza la sección de resultados
        let html = `
        <h3>Resultados de Simulación:</h3>
        <p><strong>Potencia de la señal inicial (dBm):</strong> ${resultados.potencia_inicial_dbm.toFixed(2)} dBm</p>
        `;
        resultados.detalles_tramos.forEach((detalle, idx) => {
            html += `<p><strong>Tramo ${detalle.numero}:</strong> Longitud del Tramo = ${detalle.longitud_tramo.toFixed(2)} km, Potencia final = ${detalle.potencia_final_dbm.toFixed(2)} dBm, Atenuación del Tramo = ${detalle.atenuacion_tramo.toFixed(2)} dB</p>`;
        });
        html += `
        <h3>Resultados Finales:</h3>
        <p><strong>Longitud Total Acumulada de la Red:</strong> ${resultados.longitud_total.toFixed(2)} km</p>
        <p><strong>Potencia de la señal inicial (dBm):</strong> ${resultados.potencia_inicial_dbm.toFixed(2)} dBm</p>
        <p><strong>Potencia de la señal recibida (dBm):</strong> ${resultados.potencia_final_dbm.toFixed(2)} dBm</p>
        <p><strong>Potencia de la señal recibida (mW):</strong> ${(Math.pow(10, resultados.potencia_final_dbm / 10)).toFixed(2)} mW</p>
        <p><strong>Atenuación total simulada (dB):</strong> ${resultados.atenuacion_total.toFixed(2)} dB</p>
        <p><strong>Sensibilidad del receptor (dBm):</strong> ${resultados.sensibilidad_receptor_dbm.toFixed(2)} dBm</p>
        `;

        // Añade aquí la nueva etiqueta "Estado de la red"
        if (resultados.potencia_final_dbm >= resultados.sensibilidad_receptor_dbm) {
            html += `<p><strong>Estado de la red:</strong> <span class="text-success">OPERACIONAL</span></p>`;
        } else {
            html += `<p><strong>Estado de la red:</strong> <span class="text-danger">NO OPERACIONAL</span></p>`;
        }

        // Estado detallado del enlace existente
        if (resultados.potencia_final_dbm >= resultados.sensibilidad_receptor_dbm) {
            html += `<p class="text-success"><strong>Estado del Enlace:</strong> ¡Éxitoso! La potencia de la señal recibida (${resultados.potencia_final_dbm.toFixed(2)} dBm) es mayor o igual a la sensibilidad del receptor (${resultados.sensibilidad_receptor_dbm.toFixed(2)} dBm).</p>`;
        } else {
            const missing_dbm = resultados.sensibilidad_receptor_dbm - resultados.potencia_final_dbm;
            html += `<p class="text-danger"><strong>Estado del Enlace:</strong> Advertencia: La potencia de la señal recibida (${resultados.potencia_final_dbm.toFixed(2)} dBm) es menor que la sensibilidad del receptor (${resultados.sensibilidad_receptor_dbm.toFixed(2)} dBm), faltan (${missing_dbm.toFixed(2)} dBm)</p>`;
        }
        document.getElementById('resultados-container').innerHTML = html;

        // Actualiza las gráficas de Plotly
        if (resultados.plot_dbm_plotly) {
            Plotly.react('plotly-graph-dbm', resultados.plot_dbm_plotly.data, resultados.plot_dbm_plotly.layout);
        }
        if (resultados.plot_linear_plotly) {
            Plotly.react('plotly-graph-linear', resultados.plot_linear_plotly.data, resultados.plot_linear_plotly.layout);
        }
    })
    .catch(err => {
        document.getElementById('resultados-container').style.display = 'block';
        document.getElementById('resultados-container').innerHTML = "<p>Error al calcular resultados. Verifique la consola.</p>";
        console.error("Error en fetch /calcular:", err);
    });
});
</script>
<script>

        function dibujarRed() {
            // Initialize with empty datasets if not already done
            nodos = new vis.DataSet([]);
            enlaces = new vis.DataSet([]);

            const container = document.getElementById('red');
            const opciones = {
                physics: { enabled: false },
                interaction: {
                    tooltipDelay: 10,
                    hover: true,
                    zoomView: false,             // Disable default mouse wheel/pinch zoom
                    navigationButtons: true,     // Enable UI controls for zoom/pan
                    dragNodes: true,             // Explicitly keep default
                    dragView: true               // Explicitly keep default
                }
            };

            red = new vis.Network(container, { nodes: nodos, edges: enlaces }, opciones);

            // Tooltip and click logic (mostly unchanged, but ensure params are handled well)
            let selectedElement = null;
            let tooltip;

            // Tooltip para nodos
            red.on('hoverNode', function (event) {
                const nodeId = event.node;
                const nodeData = nodos.get(nodeId);

                if (!nodeData) { // Simplified check, specific content handled below
                    return;
                }

                tooltip = document.createElement('div');
                tooltip.className = 'tooltip-custom';

                let tooltipContent = `<strong>${nodeData.label}</strong><br>`;
                if (nodeData.id === 1) { // Transmisor
                    // Use displayPotenciaValue and displayPotenciaUnit for tooltip
                    const displayVal = nodeData.displayPotenciaValue !== undefined ? nodeData.displayPotenciaValue : nodeData.potencia;
                    const displayUnit = nodeData.displayPotenciaUnit || 'dBm'; // Default to dBm if not set
                    tooltipContent += `<strong>Potencia:</strong> ${displayVal} ${displayUnit}<br>`;
                } else if (nodeData.id === 3) { // Receptor
                    tooltipContent += `<strong>Sensibilidad:</strong> ${nodeData.sensibilidad_receptor_dbm} dBm<br>`;
                }
                // Generic parameters (if nodeData.parametros exists)
                if (nodeData.parametros) {
                    for (const key in nodeData.parametros) {
                        tooltipContent += `<strong>${key.replace(/_/g, ' ')}:</strong> ${nodeData.parametros[key]}<br>`;
                    }
                }
                tooltip.innerHTML = tooltipContent;

                document.body.appendChild(tooltip);

                const pointer = event.event.srcEvent || event.event;
                tooltip.style.left = (pointer.clientX + 10) + 'px';
                tooltip.style.top = (pointer.clientY + 20) + 'px';
                tooltip.style.opacity = 1;
            });

            red.on('blurNode', function () {
                if (tooltip) {
                    tooltip.remove();
                    tooltip = null;
                }
            });

            // Tooltip para enlaces
            red.on('hoverEdge', function (event) {
                const edgeId = event.edge;
                const edgeData = enlaces.get(edgeId);

                if (!edgeData || !edgeData.parametros) {
                    return;
                }

                tooltip = document.createElement('div');
                tooltip.className = 'tooltip-custom';

                // English tooltips for fiber spans
                let tooltipTitle = "Fiber Span Details";
                if (edgeData.parametros.label) { // Use internal label if available
                    tooltipTitle = edgeData.parametros.label; // e.g., "Tramo de Fibra 1"
                }
                let tooltipContent = `<strong>${tooltipTitle}</strong><hr style="margin: 5px 0;">`;

                const paramLabels = {
                    length_stretch: "Longitud del tramo de Fibra",
                    loss_coef: "Coeficiente de pérdida",
                    att_in: "Pérdidas de entrada",
                    con_in: "Pérdida del conector de entrada",
                    con_out: "Pérdida del conector de salida"
                };
                for (const key in edgeData.parametros) {
                    if (key === 'label') continue; // Already used for title or not needed here

                    let displayKey = paramLabels[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); // Fallback for other params
                    let value = edgeData.parametros[key];
                    let unit = '';

                    if (key === 'loss_coef') unit = ' dB/km';
                    else if (key === 'length_stretch') unit = ' km';
                    else if (key.includes('con_') || key.includes('att_')) unit = ' dB';
                    
                    tooltipContent += `<strong>${displayKey}:</strong> ${value}${unit}<br>`;
                }

                tooltip.innerHTML = tooltipContent;
                document.body.appendChild(tooltip);

                const pointer = event.event.srcEvent || event.event;
                tooltip.style.left = (pointer.clientX + 15) + 'px'; // Adjusted offset
                tooltip.style.top = (pointer.clientY + 15) + 'px'; // Adjusted offset
                tooltip.style.opacity = 1;
            });

            red.on('blurEdge', function () {
                if (tooltip) {
                    tooltip.remove();
                    tooltip = null;
                }
            });
            
            // Click para abrir modal de edición
            red.on('click', function (event) {
                if (tooltip) { // Hide tooltip on click
                    tooltip.remove();
                    tooltip = null;
                }

                const modalNodeLabelContainer = document.getElementById('modalNodeLabelContainer');
                const modalNodePotenciaContainer = document.getElementById('modalNodePotenciaContainer');
                const additionalParamsDiv = document.getElementById('additionalParams');
                additionalParamsDiv.innerHTML = ''; // Clear previous params

                // Default visibility - will be overridden based on element type
                if (modalNodeLabelContainer) modalNodeLabelContainer.style.display = 'none';
                if (modalNodePotenciaContainer) modalNodePotenciaContainer.style.display = 'none';

                if (event.nodes.length > 0) {
                    const nodeId = event.nodes[0];
                    const nodeData = nodos.get(nodeId);
                    selectedElement = { type: 'node', data: nodeData };

                    document.getElementById('editNodeModalLabel').innerText = 'Editar ' + nodeData.label;
                    // document.getElementById('nodeLabel').value = nodeData.label || ''; // Handled by specific cases

                    if (nodeData.id === 1) { // Transmisor
                        document.getElementById('editNodeModalLabel').innerText = 'Editar Transmisor (Edit Transmitter)';
                        
                        // Use displayValue and displayUnit if available, otherwise default to potencia (dBm)
                        const displayValue = nodeData.displayPotenciaValue !== undefined ? nodeData.displayPotenciaValue : nodeData.potencia;
                        const displayUnit = nodeData.displayPotenciaUnit || 'dBm';

                        const selectedDbm = displayUnit === 'dBm' ? 'selected' : '';
                        const selectedMw = displayUnit === 'mW' ? 'selected' : '';

                        additionalParamsDiv.innerHTML = `
                        <div class="mb-3">
                            <label for="nodePotenciaTxValue" class="form-label">Potencia (Power)</label>
                            <div class="input-group">
                                <input type="number" step="any" class="form-control" id="nodePotenciaTxValue" name="potenciaValue" value="${displayValue}">
                                <select class="form-select" id="nodePotenciaTxUnit" style="max-width: 85px;">
                                    <option value="dBm" ${selectedDbm}>dBm</option>
                                    <option value="mW" ${selectedMw}>mW</option>
                                </select>
                            </div>
                        </div>`;

                        // Listener for unit change is removed as per new requirement.
                        // The numerical value in the input field will not change when units are switched.
                        // Conversion happens only at the time of saving.

                    } else if (nodeData.id === 3) { // Receptor
                        document.getElementById('editNodeModalLabel').innerText = 'Editar Receptor (Edit Receiver)';
                         additionalParamsDiv.innerHTML += `
                        <div class="mb-3">
                            <label for="nodeSensibilidadRx" class="form-label">Sensibilidad del Receptor (sensibilidad_receptor_dbm, dBm)</label>
                            <input type="number" step="0.01" class="form-control" id="nodeSensibilidadRx" name="sensibilidad_receptor_dbm" value="${nodeData.sensibilidad_receptor_dbm || globalReceiverSensitivityDbm}">
                        </div>`;
                    } else { // Intermediate nodes (connectors)
                        document.getElementById('editNodeModalLabel').innerText = 'Nodo de Conexión';
                        additionalParamsDiv.innerHTML = '<p>Este nodo de conexión no tiene parámetros editables.</p>';
                    }

                } else if (event.edges.length > 0) {
                    const edgeId = event.edges[0];
                    const edgeData = enlaces.get(edgeId);
                    selectedElement = { type: 'edge', data: edgeData };

                    document.getElementById('editNodeModalLabel').innerText = 'Editar ' + (edgeData.parametros.label || `Tramo de Fibra ${edgeData.id}`);
                    
                    if (modalNodeLabelContainer) modalNodeLabelContainer.style.display = 'block'; // Show label field for edge
                    document.getElementById('nodeLabel').value = edgeData.parametros.label || ''; // This is the user-defined label like "Tramo de Fibra 1"

                    // Fiber specific parameters with updated bilingual labels
                    const fiberParamsConfig = {
                        'length_stretch': { label: 'Longitud del Tramo (length_stretch)', unit: ' (km)' }, // Re-added for modal editing
                        'loss_coef': { label: 'Coeficiente de Pérdida (loss_coef)', unit: ' (dB/km)' },
                        'att_in': { label: 'Pérdidas de entrada (att_in)', unit: ' (dB)' },
                        'con_in': { label: 'Pérdida Conector Entrada (con_in)', unit: ' (dB)' },
                        'con_out': { label: 'Pérdida Conector Salida (con_out)', unit: ' (dB)' }
                    };

                    for (const key in fiberParamsConfig) {
                        if (Object.hasOwnProperty.call(edgeData.parametros, key)) {
                            const config = fiberParamsConfig[key];
                            additionalParamsDiv.innerHTML += `
                            <div class="mb-3">
                                <label for="param_${key}" class="form-label">${config.label}${config.unit}</label>
                                <input type="number" step="0.01" class="form-control" id="param_${key}" name="${key}" value="${edgeData.parametros[key]}">
                            </div>`;
                        }
                    }
                     if (additionalParamsDiv.innerHTML === '') {
                        additionalParamsDiv.innerHTML = '<p>No hay parámetros editables para este tramo.</p>';
                    }
                } else {
                    return; // No element clicked
                }
                
                const modal = new bootstrap.Modal(document.getElementById('editNodeModal'));
                modal.show();
            });


            // Guardar cambios modal
            document.getElementById('saveNodeChanges').addEventListener('click', function () {
                if (!selectedElement) return;

                const form = document.getElementById('editNodeForm');
                const inputs = form.querySelectorAll('#additionalParams input');

                if (selectedElement.type === 'node') {
                    const nodeData = selectedElement.data;

                    if (nodeData.id === 1) { // Transmisor
                        const powerValueInput = form.querySelector('#nodePotenciaTxValue');
                        const powerUnitSelect = form.querySelector('#nodePotenciaTxUnit');
                        
                        if (powerValueInput && powerUnitSelect) {
                            const rawValueStr = powerValueInput.value;
                            const selectedUnit = powerUnitSelect.value;
                            let rawValueNum = parseFloat(rawValueStr);

                            if (isNaN(rawValueNum)) {
                                console.error("Invalid power value entered. Save cancelled.");
                                alert("Valor de potencia inválido. No se guardaron los cambios.");
                                return; 
                            }

                            // Store the exact entered value and unit for display purposes
                            nodeData.displayPotenciaValue = rawValueNum;
                            nodeData.displayPotenciaUnit = selectedUnit;
                            // Also update the global display preferences
                            globalDisplayTxPowerValue = rawValueNum;
                            globalDisplayTxPowerUnit = selectedUnit;

                            // Determine the value to store for calculations (in dBm)
                            let powerToStoreInDbm = rawValueNum;
                            if (selectedUnit === 'mW') {
                                if (rawValueNum <= 0) {
                                    alert("La potencia en mW debe ser un valor positivo. No se guardaron los cambios.");
                                    console.error("Power in mW must be positive.");
                                    return;
                                }
                                powerToStoreInDbm = mwToDbm(rawValueNum); 
                            }
                            
                            if (isNaN(powerToStoreInDbm)) {
                                console.error("Power conversion resulted in NaN. Save cancelled.");
                                alert("Error en la conversión de potencia. No se guardaron los cambios.");
                                return;
                            }

                            nodeData.potencia = parseFloat(powerToStoreInDbm.toFixed(2)); 
                            globalTxPowerDbm = nodeData.potencia; 
                        } else {
                            console.error("Could not find power input or unit selector for transmitter.");
                        }
                    } else if (nodeData.id === 3) { // Receptor
                        const sensitivityInput = form.querySelector('#nodeSensibilidadRx');
                        if (sensitivityInput) {
                            const sensitivityValue = parseFloat(sensitivityInput.value);
                             if (isNaN(sensitivityValue)) {
                                console.error("Invalid sensitivity value entered. Save cancelled.");
                                alert("Valor de sensibilidad inválido. No se guardaron los cambios.");
                                return;
                            }
                            nodeData.sensibilidad_receptor_dbm = parseFloat(sensitivityValue.toFixed(2));
                            globalReceiverSensitivityDbm = nodeData.sensibilidad_receptor_dbm;
                        }
                    }
                    nodos.update(nodeData);

                } else if (selectedElement.type === 'edge') {
                    const edgeData = selectedElement.data; // Contains the edge id
                    // Update edgeData.parametros from modal inputs
                    inputs.forEach((input) => {
                        if (['length_stretch', 'loss_coef', 'att_in', 'con_in', 'con_out'].includes(input.name)) {
                            edgeData.parametros[input.name] = parseFloat(input.value);
                        } else {
                            // For the label of the span itself, which is directly on editNodeForm
                            if (input.id === 'nodeLabel' && input.name === 'label') {
                                edgeData.parametros[input.name] = input.value;
                            } else {
                                edgeData.parametros[input.name] = input.value; // Other params if any
                            }
                        }
                    });
                     // Also update the main label from the dedicated field if it was shown for edges
                    const mainLabelInput = document.getElementById('nodeLabel');
                    if (mainLabelInput && mainLabelInput.closest('#modalNodeLabelContainer').style.display !== 'none'){
                         edgeData.parametros.label = mainLabelInput.value;
                    }

                    enlaces.update(edgeData); // Update Vis.js dataset

                    // Store these parameters persistently against the edge's ID
                    if (edgeData.id) { // Ensure edge has an ID
                        persistentSpanParams[edgeData.id] = {
                            length_stretch: parseFloat(edgeData.parametros.length_stretch),
                            loss_coef: parseFloat(edgeData.parametros.loss_coef),
                            att_in: parseFloat(edgeData.parametros.att_in),
                            con_in: parseFloat(edgeData.parametros.con_in),
                            con_out: parseFloat(edgeData.parametros.con_out),
                            label: edgeData.parametros.label // also persist custom label if any
                        };
                    }
                }

                const modal = bootstrap.Modal.getInstance(document.getElementById('editNodeModal'));
                modal.hide();
                // alert('Cambios guardados. Presione "Realizar Cálculos" para actualizar los resultados y gráficas.');
                // Optionally, trigger calculation automatically:
                // document.querySelector('.calulos-button').click();
            });

            // Cambiar número de tramos de fibra
            document.getElementById('fiberSpanSelector').addEventListener('change', function (event) {
                // const numSpans = parseInt(event.target.value);
                // generateFiberSpanForm(numSpans); // REMOVED - No longer generating form here
            });
            
            // Guardar (Aplicar) N° de Tramos y actualizar red (called by button)
            document.getElementById('saveFiberSpans').addEventListener('click', function () {
                buildNetworkFromForm(); // Builds network with default lengths for spans
            });

            // Event listener for the new Reset Layout button
            document.getElementById('resetLayoutButton').addEventListener('click', function() {
                buildNetworkFromForm(); // Re-uses the existing function to rebuild and reset positions
            });

            function buildNetworkFromForm() {
                const numSpans = parseInt(document.getElementById('fiberSpanSelector').value);
                const defaultLengthPerSpan = 23; // Default length in km for new spans

                nodos.clear();
                enlaces.clear();

                const nodeIds = [];
                // Emisor (Tx) - ID 1
                nodos.add({
                    id: 1, label: 'Transmisor', x: 50, y: 100, shape: 'box',
                    potencia: globalTxPowerDbm, // Canonical dBm value
                    displayPotenciaValue: globalDisplayTxPowerValue, // Use persisted display value
                    displayPotenciaUnit: globalDisplayTxPowerUnit,   // Use persisted display unit
                    unidad_potencia: 'dBm', // Retained for now, might be useful for generic tooltips if any
                    parametros: { 'descripcion': 'Fuente de la señal óptica' } // Basic param
                });
                nodeIds.push(1);

                // Nodos intermedios (conexiones entre fibras)
                let currentX = 50;
                const spacing = 200; // Horizontal spacing between nodes

                for (let i = 0; i < numSpans -1; i++) { // Only create intermediate nodes if > 1 span
                    currentX += spacing;
                    const intermediateNodeId = 100 + i; // Unique IDs for intermediate nodes
                    nodos.add({
                        id: intermediateNodeId, label: '', x: currentX, y: 100, shape: 'circle', size:10, // Label is now empty
                        parametros: { 'tipo': 'Punto de conexión' }
                    });
                    nodeIds.push(intermediateNodeId);
                }

                
                currentX += spacing;
                nodos.add({
                    id: 3, label: 'Receptor', x: currentX, y: 100, shape: 'box',
                    sensibilidad_receptor_dbm: globalReceiverSensitivityDbm, // Use global
                    parametros: { 'descripcion': 'Detecta la señal óptica' }
                });
                nodeIds.push(3);
                
                for (let i = 0; i < numSpans; i++) {
                    const edgeId = 'edge_' + i; // Assign a predictable, consistent ID
                    let currentFiberLength = defaultLengthPerSpan;

                    // Default parameters for each new fiber span
                    let edgeParams = {
                        label: `Tramo de Fibra ${i + 1}`, // Default label
                        length_stretch: defaultLengthPerSpan,
                        loss_coef: 0.2,                  
                        att_in: 0.0,                     
                        con_in: 0.25,                    
                        con_out: 0.30                    
                    };

                    // If persistent data exists for this edgeId, merge/override defaults
                    if (persistentSpanParams[edgeId]) {
                        // Merge ensures that if new default params are added later, they are included
                        // and user-set values for the specific persisted keys take precedence.
                        Object.assign(edgeParams, persistentSpanParams[edgeId]);
                    }

                    enlaces.add({
                        id: edgeId, // Use the predictable ID
                        from: nodeIds[i],
                        to: nodeIds[i+1],
                        label: '', // Visual label on canvas is kept empty
                        parametros: edgeParams
                    });
                }
                red.setData({ nodes: nodos, edges: enlaces });
                // Optional: Automatically trigger calculation after rebuilding network
                // document.querySelector('.calulos-button').click();
            }
            
            // Initial render of Plotly graphs with data from Flask
            const initialPlotDbmData = JSON.parse('{{ initial_graph_dbm | tojson | safe }}');
            const initialPlotLinearData = JSON.parse('{{ initial_graph_linear | tojson | safe }}');

            if (initialPlotDbmData && initialPlotDbmData.data && initialPlotDbmData.layout) {
                Plotly.newPlot('plotly-graph-dbm', initialPlotDbmData.data, initialPlotDbmData.layout);
            } else {
                console.warn("Initial dBm plot data not available or malformed.");
                // document.getElementById('plotly-graph-dbm').innerHTML = "<p>Gráfica dBm no disponible.</p>";
            }

            if (initialPlotLinearData && initialPlotLinearData.data && initialPlotLinearData.layout) {
                Plotly.newPlot('plotly-graph-linear', initialPlotLinearData.data, initialPlotLinearData.layout);
            } else {
                 console.warn("Initial Linear plot data not available or malformed.");
                // document.getElementById('plotly-graph-linear').innerHTML = "<p>Gráfica Lineal no disponible.</p>";
            }


            // Initial call to set up the form and network based on default selector (1 span)
             // generateFiberSpanForm(parseInt(document.getElementById('fiberSpanSelector').value));
             buildNetworkFromForm(); // Draw initial network
        }

        // Initialize everything when the DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            dibujarRed(); // dibujarRed will call buildNetworkFromForm, which initializes with default spans/lengths
        });
    </script>
</body>