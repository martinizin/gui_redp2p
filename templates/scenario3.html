<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topolog√≠a de Red</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        /* Main layout containers */
        body {
            padding-top: 70px; /* Space for fixed navigation */
            font-size: 0.9rem;
        }
        #navigation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: white;
            z-index: 1000;
            padding: 8px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Upload section container */
        #upload-section {
            background-color: white;
            padding: 20px;
            margin: 10px auto;
            max-width: 1400px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }
        #upload-section h2 {
            color: #343a40;
            font-size: 1.2rem;
            margin-bottom: 8px;
            text-align: center;
            font-weight: 500;
        }
        #controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        #controls h1 {
            font-size: 0.9rem;
            margin: 0;
            color: #495057;
            font-weight: 500;
        }
        
        /* Map section container */
        #map-section {
            padding: 0;
            margin-top: 0;
        }
        #map-container {
            height: 50vh;
            width: 100%;
            max-width: 1400px;
            min-height: 380px;
            margin: 0 auto;
            position: relative;
            border: 3px solid #e0e0e0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            transition: border-color 0.3s ease;
            background-color: white;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            body {
                padding-top: 90px; /* More space for mobile navigation */
            }
            #upload-section {
                margin: 5px;
                padding: 15px;
            }
            #map-section {
                padding: 20px 10px;
            }
            #map-container {
                height: 60vh;
                min-height: 400px;
                border-radius: 8px;
            }
            #controls {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        #map-container.active {
            border-color: #007bff;
            box-shadow: 0 8px 25px rgba(0,123,255,0.3);
        }
        #zoom-hint {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
            z-index: 1000;
            display: none;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        #topology-select {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ced4da;
            background-color: white;
            font-size: 0.95rem;
            min-width: 200px;
        }
        #topology-select:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            outline: none;
        }
        #upload-button {
            padding: 8px 16px;
            border-radius: 5px;
            border: 1px solid #007bff;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        #upload-button:hover {
            background-color: #0056b3;
            border-color: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,123,255,0.3);
        }
        
        /* Parameters Panel Styles */
        #parameters-panel {
            position: fixed;
            right: -400px;
            top: 80px;
            width: 380px;
            height: calc(100vh - 100px);
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px 0 0 8px;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1001;
            display: flex;
            flex-direction: column;
        }
        #parameters-panel.open {
            right: 0;
        }
        #parameters-panel .panel-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #parameters-panel .panel-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: #343a40;
        }
        #parameters-panel .panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        .parameter-group {
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background: #f8f9fa;
        }
        .parameter-group-header {
            background: #007bff;
            color: white;
            padding: 8px 12px;
            font-weight: 500;
            font-size: 0.9rem;
            border-radius: 5px 5px 0 0;
        }
        .parameter-item {
            padding: 8px 12px;
            border-bottom: 1px solid #e9ecef;
            background: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .parameter-item:last-child {
            border-bottom: none;
            border-radius: 0 0 5px 5px;
        }
        .parameter-label {
            font-size: 0.85rem;
            color: #495057;
            font-weight: 500;
            flex: 1;
            cursor: help;
        }
        .parameter-value {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .parameter-input {
            width: 80px;
            padding: 4px 6px;
            border: 1px solid #ced4da;
            border-radius: 3px;
            font-size: 0.8rem;
            text-align: right;
        }
        .parameter-input:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
        }
        .parameter-unit {
            font-size: 0.75rem;
            color: #6c757d;
            min-width: 35px;
        }
        .close-panel {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #6c757d;
        }
        .close-panel:hover {
            color: #343a40;
        }
        
        /* Tooltip Styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1002;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
        }
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Calculation Section Styles */
        #calculation-section {
            padding: 0 15px;
            max-width: 1400px;
            margin: 10px auto 10px auto; /* Further reduced margins */
            background-color: transparent;
            border-top: none;
        }
        .calculation-panel {
            background-color: white;
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
            height: 100%;
        }
        .panel-title {
            font-size: 1rem;
            color: #343a40;
            margin-bottom: 12px;
            font-weight: 500;
            border-bottom: 1px solid #eee;
            padding-bottom: 6px;
        }
        .form-row-flex {
            display: flex;
            gap: 12px;
            margin-bottom: 8px;
            align-items: flex-start;
        }
        .flex-grow {
            flex-grow: 1;
        }
        .align-self-flex-end {
            align-self: flex-end;
        }
        .sub-panel-title {
            font-size: 0.95rem;
            color: #6c757d;
            margin-top: 0;
            margin-bottom: 10px;
            font-weight: 500;
        }
        .form-group {
            margin-bottom: 0.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: .25rem;
            font-weight: 500;
            color: #495057;
            font-size: 0.85rem;
        }
        .form-control, .custom-select, .btn {
            padding: .275rem .65rem;
            font-size: 0.9rem;
            border-radius: .2rem;
        }
        .custom-select {
            height: calc(1.5em + .55rem + 2px);
        }
        #calculate-route-button {
            width: 100%;
            padding: 0.4rem 1rem;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .radio-group {
            padding-top: 0.25rem;
        }
        .form-check-label {
            font-weight: 400;
        }

        /* Custom InfoWindow Styles */
        .custom-infowindow {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            padding: 0;
            max-width: 250px; /* Smaller width */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 13px; /* Smaller font */
            color: #333;
        }
        .custom-infowindow-header {
            font-size: 15px; /* Smaller font */
            font-weight: 600;
            color: #ffffff;
            margin: 0;
            padding: 8px 12px; /* Reduced padding */
            background: #007bff;
            border-bottom: 1px solid #0069d9;
            border-radius: 8px 8px 0 0;
        }
        .custom-infowindow-content {
            padding: 12px; /* Reduced padding */
        }
        .custom-infowindow-content p {
            margin: 0 0 6px 0;
            line-height: 1.5;
        }
        .custom-infowindow-content strong {
            font-weight: 600;
            color: #555;
            min-width: 80px;
            display: inline-block;
        }
        .custom-infowindow-content .param-group {
            margin-top: 5px;
            padding-left: 15px;
            border-left: 3px solid #007bff;
        }
        .custom-infowindow-content .param-group p {
            font-family: monospace;
            font-size: 13px;
            margin-bottom: 3px;
        }
        .role-source {
            color: #28a745;
            font-weight: 700;
        }
        .role-destination {
            color: #007bff;
            font-weight: 700;
        }

        /* ----- Google Maps InfoWindow Customization ----- */
        /* Hide the default white bubble and shadow */
        .gm-style .gm-style-iw-c {
            padding: 0 !important;
            background-color: transparent !important;
            box-shadow: none !important;
        }
        .gm-style .gm-style-iw-d {
           overflow: hidden !important; /* Hide scrollbars */
        }
        /* Hide the default close button */
        .gm-style .gm-style-iw-t button {
            display: none !important;
        }
        /* Hide the default arrow */
        .gm-style .gm-style-iw-t::after {
            display: none;
        }

        #navigation .h1, #navigation h1 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem !important;
        }
        #navigation .btn-group .btn {
            padding: .25rem .75rem;
            font-size: .875rem;
        }
    </style>
</head>
<body>
    <div id="navigation">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12 text-center">
                    <h1 class="mb-3">Simulador de topolog√≠as de red en google maps</h1>
                    <div class="btn-group" role="group" aria-label="Navigation">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary">Scenario 01</a>
                        <a href="{{ url_for('scenario02') }}" class="btn btn-secondary">Scenario 02</a>
                        <a href="{{ url_for('scenario03') }}" class="btn btn-primary">Scenario 03</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Upload Section Container -->
    <div id="upload-section">
        <h2>Gesti√≥n de Topolog√≠as</h2>
        <div id="controls">
            <h1>Visualizaci√≥n de Topolog√≠a</h1>
            <select id="topology-select"></select>
            <input type="file" id="topology-upload" accept="application/json" style="display: none;" />
            <button id="upload-button">Subir Archivo</button>
        </div>
    </div>

    <!-- Main Content Section: Map and Simulation Parameters -->
    <div id="main-content-section" style="max-width: 1400px; margin: 5px auto; padding: 0 15px;">
        <div class="row">
            <!-- Map Column -->
            <div class="col-lg-8">
                <div id="map-section">
                    <div id="map-container">
                        <div id="zoom-hint">Click map to enable zoom, or hold Ctrl while scrolling</div>
                        <div id="map"></div>
                    </div>
                </div>
            </div>

            <!-- Simulation Parameters Column -->
            <div class="col-lg-4">
                <div class="calculation-panel" style="height: 100%;">
                    <h3 class="panel-title">Par√°metros de Simulaci√≥n</h3>
                    <div class="form-group">
                        <label for="tx-osnr">Tx OSNR (dB)</label>
                        <input type="number" id="tx-osnr" class="form-control" value="40.0" step="0.1">
                    </div>
                    <div class="form-group">
                        <label for="baud-rate">Tasa de Baudios (GBaud)</label>
                        <input type="number" id="baud-rate" class="form-control" value="32" step="1">
                    </div>
                    <div class="form-group">
                        <label for="tx-power">Potencia Tx (dBm)</label>
                        <input type="number" id="tx-power" class="form-control" value="0.0" step="0.1">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Route Calculation Section -->
    <div id="calculation-section">
        <div class="calculation-panel">
            <h3 class="panel-title">C√°lculo de Ruta</h3>
            <h5 class="sub-panel-title">Selecci√≥n de Nodos</h5>
            <div class="form-row-flex">
                <div class="form-group flex-grow">
                    <label for="source-node">Nodo Origen</label>
                    <select id="source-node" class="form-control custom-select"></select>
                </div>
                <div class="form-group flex-grow">
                    <label for="destination-node">Nodo Destino</label>
                    <select id="destination-node" class="form-control custom-select"></select>
                </div>
            </div>
            <div class="form-row-flex">
                <div class="form-group">
                    <label>Criterio de C√°lculo</label>
                    <div class="radio-group">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="criteria" id="criteria-distance" value="distance" checked>
                            <label class="form-check-label" for="criteria-distance">Distancia</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="criteria" id="criteria-osnr" value="osnr">
                            <label class="form-check-label" for="criteria-osnr">OSNR</label>
                        </div>
                    </div>
                </div>
                <div class="form-group align-self-flex-end">
                    <button id="calculate-route-button" class="btn btn-primary">Calcular Ruta</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Parameters Panel -->
    <div id="parameters-panel">
        <div class="panel-header">
            <h3>Network Parameters</h3>
            <button class="close-panel" onclick="closeParametersPanel()">&times;</button>
        </div>
        <div class="panel-body">
            <div id="parameters-content">
                <p style="color: #6c757d; text-align: center; padding: 20px;">
                    Click on a network element to view and modify its parameters
                </p>
            </div>
        </div>
    </div>

    <script>
        let map;
        let markers = {};
        let infoWindows = {};
        let polylines = [];
        let currentTopologyData = null;
        let defaultNodeIcon;
        
        // Inicializa el mapa
        function inicializarMapa() {
            defaultNodeIcon = {
                url: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',
                scaledSize: new google.maps.Size(28, 28)
            };
            
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: -1.831239, lng: -78.183406 }, // Centro de Ecuador
                zoom: 7,
                scrollwheel: false, // Initially disabled
                gestureHandling: 'greedy' // Allow panning and zooming with touch/mouse controls
            });

            // Implement explicit interaction-based zoom control
            const mapContainer = document.getElementById('map-container');
            const zoomHint = document.getElementById('zoom-hint');
            let mapIsActive = false;
            
            // Show hint on hover
            mapContainer.addEventListener('mouseenter', function() {
                if (!mapIsActive) {
                    zoomHint.style.display = 'block';
                }
            });
            
            mapContainer.addEventListener('mouseleave', function() {
                zoomHint.style.display = 'none';
                if (mapIsActive) {
                    mapIsActive = false;
                    mapContainer.classList.remove('active');
                    map.setOptions({ scrollwheel: false });
                }
            });
            
            // Enable map interaction when user clicks on the map
            mapContainer.addEventListener('mousedown', function() {
                mapIsActive = true;
                mapContainer.classList.add('active');
                zoomHint.style.display = 'none';
                map.setOptions({ scrollwheel: true });
            });
            
            // Disable map scrolling when clicking outside the map
            document.addEventListener('click', function(e) {
                if (!mapContainer.contains(e.target)) {
                    mapIsActive = false;
                    mapContainer.classList.remove('active');
                    map.setOptions({ scrollwheel: false });
                }
            });
            
            // Handle scroll events with explicit control
            mapContainer.addEventListener('wheel', function(e) {
                // Allow map zoom only if map is active OR Ctrl key is held
                if (mapIsActive || e.ctrlKey) {
                    map.setOptions({ scrollwheel: true });
                    e.preventDefault(); // Prevent page scroll
                    e.stopPropagation();
                } else {
                    map.setOptions({ scrollwheel: false });
                    // Allow normal page scrolling - do nothing to let event bubble up
                }
            }, { passive: false });

            // Carga los nombres de las topolog√≠as y llena el selector
            fetch('/get_topology_names')
                .then(response => response.json())
                .then(files => {
                    const select = document.getElementById('topology-select');
                    files.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file;
                        option.textContent = file.replace('.json', '');
                        select.appendChild(option);
                    });

                    // Carga la topolog√≠a inicial
                    if (files.length > 0) {
                        cargarTopologia(files[0]);
                    }
                });

            // Agrega el detector de eventos de cambio al selector
            document.getElementById('topology-select').addEventListener('change', (e) => {
                cargarTopologia(e.target.value);
            });

            document.getElementById('source-node').addEventListener('change', () => highlightSelectedNodes());
            document.getElementById('destination-node').addEventListener('change', () => highlightSelectedNodes());

            const uploadButton = document.getElementById('upload-button');
            const fileInput = document.getElementById('topology-upload');

            uploadButton.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', () => {
                const file = fileInput.files[0];
                if (!file) {
                    return;
                }

                const formData = new FormData();
                formData.append('file', file);

                fetch('/upload_topology', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.filename) {
                        // Actualiza la lista de topolog√≠as
                        fetch('/get_topology_names')
                            .then(response => response.json())
                            .then(files => {
                                const select = document.getElementById('topology-select');
                                select.innerHTML = ''; // Limpia las opciones existentes
                                files.forEach(f => {
                                    const option = document.createElement('option');
                                    option.value = f;
                                    option.textContent = f.replace('.json', '');
                                    select.appendChild(option);
                                });
                                
                                // Selecciona y carga la nueva topolog√≠a
                                select.value = data.filename;
                                cargarTopologia(data.filename);
                                fileInput.value = ''; // Reinicia el input del archivo
                            });
                    } else {
                        alert('Fall√≥ la subida del archivo: ' + (data.error || 'Error desconocido'));
                    }
                })
                .catch(error => {
                    console.error('Error al subir el archivo:', error);
                    alert('Ocurri√≥ un error durante la subida del archivo.');
                });
            });
        }

        function cargarTopologia(filename) {
            fetch(`/get_topology?filename=${encodeURIComponent(filename)}`)
                .then(response => response.json())
                .then(data => {
                    currentTopologyData = data;
                    dibujarTopologiaEnMapa(data);
                    populateTransceiverDropdowns(data);
                })
                .catch(error => console.error('Error cargando la topolog√≠a:', error));
        }

        function populateTransceiverDropdowns(data) {
            const sourceSelect = document.getElementById('source-node');
            const destinationSelect = document.getElementById('destination-node');

            sourceSelect.innerHTML = '<option value="">Seleccione nodo origen</option>';
            destinationSelect.innerHTML = '<option value="">Seleccione nodo destino</option>';

            const transceivers = (data.elements || []).filter(el => el.type === 'Transceiver');

            if (transceivers.length === 0) {
                const option = '<option value="" disabled>No se encontraron transceivers</option>';
                sourceSelect.innerHTML = option;
                destinationSelect.innerHTML = option;
                return;
            }

            transceivers.forEach(t => {
                const option = document.createElement('option');
                option.value = t.uid;
                option.textContent = t.uid;
                sourceSelect.appendChild(option.cloneNode(true));
                destinationSelect.appendChild(option);
            });
        }

        function dibujarTopologiaEnMapa(data) {
            limpiarMapa();
            const nodesMap = procesarNodos(data);
            dibujarNodos(nodesMap);
            dibujarEnlaces(data, nodesMap);
        }

        function procesarNodos(data) {
            const nodesMap = {};
            const elements = data.elements || [];
            
            elements.forEach(el => {
                // Omite elementos que no son nodos de red o no tienen ubicaci√≥n
                if (el.type === "Fiber" || el.type === "fibre") return;
                
                const nodeId = normalizarIdNodo(el.uid);
                const location = extraerUbicacion(el);
                
                if (location && location.lat && location.lng) {
                    nodesMap[nodeId] = {
                        id: nodeId,
                        latitude: parseFloat(location.lat),
                        longitude: parseFloat(location.lng),
                        title: String(el.uid),
                        type: el.type,
                        city: location.city || el.metadata?.location?.city,
                        raw: el
                    };
                }
            });
            return nodesMap;
        }

        function extraerUbicacion(element) {
            if (element.metadata?.location) {
                return {
                    lat: element.metadata.location.latitude,
                    lng: element.metadata.location.longitude,
                    city: element.metadata.location.city
                };
            } else if (element.location) {
                return {
                    lat: element.location.latitude || element.location.lat,
                    lng: element.location.longitude || element.location.lng,
                    city: element.location.city
                };
            }
            return null;
        }

        function dibujarNodos(nodesMap) {
            Object.values(nodesMap).forEach(node => {
                const marker = new google.maps.Marker({
                    position: { lat: node.latitude, lng: node.longitude },
                    map: map,
                    title: node.title,
                    icon: defaultNodeIcon
                });
                markers[node.id] = marker;

                const infoWindow = new google.maps.InfoWindow({
                    content: crearContenidoInfoNodo(node)
                });
                infoWindows[node.id] = infoWindow;

                marker.addListener('mouseover', () => {
                    const sourceId = document.getElementById('source-node').value;
                    const destinationId = document.getElementById('destination-node').value;
                    let role = null;
                    if (node.id === sourceId) role = "Nodo Origen";
                    if (node.id === destinationId) role = "Nodo Destino";
                    
                    const content = crearContenidoInfoNodo(node, role);
                    infoWindow.setContent(content);
                    infoWindow.open(map, marker);
                });

                marker.addListener('mouseout', () => {
                    infoWindow.close();
                });

                marker.addListener("click", () => {
                    // Show parameters panel if element has parameters
                    if (currentTopologyData && currentTopologyData.elements) {
                        const element = currentTopologyData.elements.find(e => normalizarIdNodo(e.uid) === node.id);
                        if (element && element.parameters) {
                            showElementParameters(element);
                        }
                    }
                });
            });
        }

        function dibujarEnlaces(data, nodesMap) {
            const elements = data.elements || [];
            const connections = data.connections || [];

            if (connections.length === 0) return;

            const elementsMap = new Map(elements.map(el => [normalizarIdNodo(el.uid), el]));
            const adj = new Map();

            connections.forEach(c => {
                const from = normalizarIdNodo(c.from_node);
                const to = normalizarIdNodo(c.to_node);
                if (!adj.has(from)) adj.set(from, new Set());
                if (!adj.has(to)) adj.set(to, new Set());
                adj.get(from).add(to);
                adj.get(to).add(from); // Tratar como no dirigido para encontrar el camino
            });

            const drawnLinks = new Set();

            for (const startNodeId of Object.keys(nodesMap)) {
                const q = [[startNodeId, [startNodeId]]];
                const visitedInSearch = new Set([startNodeId]);

                while (q.length > 0) {
                    const [currentNodeId, path] = q.shift();

                    if (!adj.has(currentNodeId)) continue;

                    for (const neighborId of adj.get(currentNodeId)) {
                        if (visitedInSearch.has(neighborId)) continue;
                        
                        if (nodesMap[neighborId]) { // Se encontr√≥ otro nodo con ubicaci√≥n
                            const linkKey = [startNodeId, neighborId].sort().join('->');
                            if (drawnLinks.has(linkKey)) continue;
                            
                            visitedInSearch.add(neighborId);
                            const newPath = [...path, neighborId];
                            
                            const startNode = nodesMap[startNodeId];
                            const endNode = nodesMap[neighborId];

                            let totalLength = 0;
                            let hasFiber = false;

                            for (const nodeId of newPath) {
                                const element = elementsMap.get(nodeId);
                                if (element && (element.type === 'Fiber' || element.type === 'fibre')) {
                                    hasFiber = true;
                                    if (element.params && element.params.length) {
                                        totalLength += element.params.length;
                                    }
                                }
                            }

                            dibujarConexion(startNode, endNode, { color: hasFiber ? "#FF0000" : "#007bff", weight: 3 });
                            drawnLinks.add(linkKey);

                            if (hasFiber && totalLength > 0) {
                                colocarAmplificadores(startNode, endNode, totalLength);
                            }
                        } else {
                            visitedInSearch.add(neighborId);
                            const newPath = [...path, neighborId];
                            q.push([neighborId, newPath]);
                        }
                    }
                }
            }
        }

        function crearContenidodelEdfa(edfa) {
            let content = `
                <div class="custom-infowindow">
                    <h3 class="custom-infowindow-header">Amplificador (EDFA)</h3>
                    <div class="custom-infowindow-content">
                        <p><strong>UID:</strong> ${edfa.uid}</p>
                        <p><strong>Variedad:</strong> ${edfa.type_variety}</p>
                        <p><strong>Coords:</strong> ${edfa.coordinates.lat.toFixed(5)}¬∞, ${edfa.coordinates.lng.toFixed(5)}¬∞</p>
                        <p><strong>Operacional:</strong></p>
                        <div class="param-group">
                            <p>Gain Target: ${edfa.operational.gain_target.toFixed(1)} dB</p>
                            <p>Delta P: ${edfa.operational.delta_p.toFixed(1)} dB</p>
                            <p>Tilt Target: ${edfa.operational.tilt_target}</p>
                            <p>Out VOA: ${edfa.operational.out_voa}</p>
                        </div>
                    </div>
                </div>`;
            return content;
        }

        function colocarAmplificadores(startNode, endNode, length) {
            const numAmps = Math.floor(length / 150);
            if (numAmps <= 0) return;

            const startPoint = new google.maps.LatLng(startNode.latitude, startNode.longitude);
            const endPoint = new google.maps.LatLng(endNode.latitude, endNode.longitude);

            for (let i = 1; i <= numAmps; i++) {
                const fraction = i / (numAmps + 1);
                const ampPosition = google.maps.geometry.spherical.interpolate(startPoint, endPoint, fraction);

                const edfaData = {
                    uid: `Edfa_fiber(${startNode.title} ‚Üí ${endNode.title})_(${i}/${numAmps})`,
                    type: 'Edfa',
                    type_variety: 'std_medium_gain',
                    operational: {
                        gain_target: 23.0,
                        delta_p: 1.0,
                        tilt_target: 0,
                        out_voa: 0
                    },
                    coordinates: {
                        lat: ampPosition.lat(),
                        lng: ampPosition.lng()
                    }
                };
                
                const infoWindow = new google.maps.InfoWindow({
                    content: crearContenidodelEdfa(edfaData)
                });
                infoWindows[edfaData.uid] = infoWindow;

                const ampMarker = new google.maps.Marker({
                    position: ampPosition,
                    map: map,
                    title: `Amplificador en el enlace ${startNode.title} a ${endNode.title}`,
                    icon: {
                        path: 'M -5,0 0,-8 5,0 0,8 Z',
                        scale: 1,
                        fillColor: '#FF4500',
                        fillOpacity: 1,
                        strokeWeight: 1,
                        strokeColor: '#8B0000'
                    }
                });
                
                ampMarker.addListener('mouseover', () => {
                    infoWindow.open(map, ampMarker);
                });
                ampMarker.addListener('mouseout', () => {
                    infoWindow.close();
                });

                ampMarker.addListener("click", () => {
                    // Create a temporary element for the amplifier with default EDFA parameters
                    const tempEdfaElement = {
                        uid: edfaData.uid,
                        type: 'Edfa',
                        type_variety: edfaData.type_variety,
                        operational: edfaData.operational,
                        parameters: {
                            'gain_flatmax': {'value': 26, 'unit': 'dB', 'editable': true, 'tooltip': 'Maximum Flat Gain - The maximum gain achieved by the amplifier under flat conditions'},
                            'gain_min': {'value': 15, 'unit': 'dB', 'editable': true, 'tooltip': 'Minimum Gain - The minimum gain achievable by the amplifier'},
                            'p_max': {'value': 23, 'unit': 'dBm', 'editable': true, 'tooltip': 'Maximum Power - The maximum output power provided by the amplifier'},
                            'nf0': {'value': 6, 'unit': 'dB', 'editable': true, 'tooltip': 'Noise Factor - The noise figure of the amplifier affecting signal-to-noise ratio'},
                            'gain_target': {'value': edfaData.operational.gain_target, 'unit': 'dB', 'editable': false, 'tooltip': 'Target Gain - The desired gain to be achieved by the amplifier based on operational settings'}
                        }
                    };
                    showElementParameters(tempEdfaElement);
                });

                markers[edfaData.uid] = ampMarker;
            }
        }

        function dibujarConexion(startNode, endNode, style) {
            const path = [
                { lat: startNode.latitude, lng: startNode.longitude },
                { lat: endNode.latitude, lng: endNode.longitude }
            ];

            const line = new google.maps.Polyline({
                path: path,
                geodesic: true,
                strokeColor: style.color || "#FF0000",
                strokeOpacity: style.opacity || 1.0,
                strokeWeight: style.weight || 2,
                map: map
            });
            polylines.push(line);

            const distance = haversine(
                startNode.latitude, startNode.longitude,
                endNode.latitude, endNode.longitude
            );

            const infoWindow = new google.maps.InfoWindow({
                content: crearContenidoInfoEnlace(style, startNode, endNode, distance)
            });

            line.addListener('mouseover', (event) => {
                infoWindow.setPosition(event.latLng);
                infoWindow.open(map);
            });
            line.addListener('mouseout', () => {
                infoWindow.close();
            });
        }
        
        function limpiarMapa() {
            Object.values(markers).forEach(marker => marker.setMap(null));
            polylines.forEach(line => line.setMap(null));
            Object.values(infoWindows).forEach(iw => iw.close());
            markers = {};
            polylines = [];
            infoWindows = {};
        }
        
        function obtenerPuntoMedio(p1, p2) {
            return {
                lat: (p1.lat + p2.lat) / 2,
                lng: (p1.lng + p2.lng) / 2
            };
        }

        function haversine(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radio de la Tierra en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return 2 * R * Math.asin(Math.sqrt(a));
        }

        function crearContenidoInfoNodo(node, role = null) {
            let roleHtml = '';
            if (role) {
                const roleClass = role === 'Nodo Origen' ? 'role-source' : 'role-destination';
                roleHtml = `<p><strong>Rol:</strong> <span class="${roleClass}">${role}</span></p>`;
            }

            let content = `
                <div class="custom-infowindow">
                    <h3 class="custom-infowindow-header">${node.title}</h3>
                    <div class="custom-infowindow-content">
                        ${roleHtml}
                        <p><strong>Ciudad:</strong> ${node.city || 'N/A'}</p>
                        <p><strong>Tipo:</strong> ${node.type}</p>
                        <p><strong>Latitud:</strong> ${node.latitude.toFixed(4)}¬∞</p>
                        <p><strong>Longitud:</strong> ${node.longitude.toFixed(4)}¬∞</p>
                    </div>
                </div>`;
            return content;
        }

        function crearContenidoInfoEnlace(linkData, startNode, endNode, distance) {
            return `
                <div class="custom-infowindow">
                    <h3 class="custom-infowindow-header">Enlace de Fibra</h3>
                    <div class="custom-infowindow-content">
                        <p><strong>Desde:</strong> ${startNode.title}</p>
                        <p><strong>Hasta:</strong> ${endNode.title}</p>
                        <p><strong>Distancia:</strong> ${distance.toFixed(2)} km</p>
                    </div>
                </div>`;
        }

        function normalizarIdNodo(id) {
            return String(id).trim();
        }

        // Parameters Panel Functions
        function openParametersPanel() {
            document.getElementById('parameters-panel').classList.add('open');
        }

        function closeParametersPanel() {
            document.getElementById('parameters-panel').classList.remove('open');
        }

        function showElementParameters(element) {
            openParametersPanel();
            const parametersContent = document.getElementById('parameters-content');
            
            if (!element.parameters) {
                parametersContent.innerHTML = '<p style="color: #dc3545; text-align: center; padding: 20px;">No parameters available for this element</p>';
                return;
            }

            let html = `<div class="parameter-group">
                <div class="parameter-group-header">${element.type}: ${element.uid}</div>`;
            
            for (const [paramName, paramData] of Object.entries(element.parameters)) {
                const inputId = `param-${element.uid}-${paramName}`;
                const isEditable = paramData.editable;
                
                html += `<div class="parameter-item">
                    <div class="parameter-label tooltip">
                        ${paramName.replace(/_/g, ' ').toUpperCase()}
                        <span class="tooltiptext">${paramData.tooltip}</span>
                    </div>
                    <div class="parameter-value">
                        <input type="number" 
                               id="${inputId}" 
                               class="parameter-input" 
                               value="${paramData.value}" 
                               step="0.1" 
                               ${!isEditable ? 'disabled' : ''}
                               ${isEditable ? `onchange="updateParameter('${element.uid}', '${paramName}', this.value)"` : ''}>
                        <span class="parameter-unit">${paramData.unit}</span>
                    </div>
                </div>`;
            }
            
            html += '</div>';
            parametersContent.innerHTML = html;
        }

        function updateParameter(elementUid, parameterName, newValue) {
            const data = {
                element_uid: elementUid,
                parameter_name: parameterName,
                new_value: parseFloat(newValue)
            };

            fetch('/update_network_parameters', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    console.log('Parameter updated successfully:', result);
                    // Update the local data
                    if (currentTopologyData && currentTopologyData.elements) {
                        const element = currentTopologyData.elements.find(e => e.uid === elementUid);
                        if (element && element.parameters && element.parameters[parameterName]) {
                            element.parameters[parameterName].value = parseFloat(newValue);
                        }
                    }
                } else {
                    console.error('Error updating parameter:', result.error);
                    alert('Error updating parameter: ' + result.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating parameter');
            });
        }

        function highlightSelectedNodes() {
            // Reset all markers to default
            for (const key in markers) {
                if (Object.prototype.hasOwnProperty.call(markers, key)) {
                    if (!key.startsWith('Edfa')) {
                         markers[key].setIcon(defaultNodeIcon);
                    }
                }
            }

            const sourceId = document.getElementById('source-node').value;
            const destinationId = document.getElementById('destination-node').value;

            const sourceIcon = {
                url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png',
                scaledSize: new google.maps.Size(32, 32)
            };

            const destinationIcon = {
                url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png',
                scaledSize: new google.maps.Size(32, 32)
            };

            if (sourceId && markers[sourceId]) {
                markers[sourceId].setIcon(sourceIcon);
            }

            if (destinationId && markers[destinationId]) {
                if (destinationId === sourceId) {
                    // Maybe a different icon if source and destination are the same
                    markers[destinationId].setIcon({
                        url: 'http://maps.google.com/mapfiles/ms/icons/purple-dot.png',
                        scaledSize: new google.maps.Size(32, 32)
                    });
                } else {
                    markers[destinationId].setIcon(destinationIcon);
                }
            }
        }
    </script>
    
    <script
        src="https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}&callback=inicializarMapa&libraries=geometry"
        async
        defer
    ></script>
</body>
